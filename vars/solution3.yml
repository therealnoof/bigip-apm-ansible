---
###############################################
# Solution 3 Variables - SAML Service Provider with Okta IDP
# This solution deploys SAML-based authentication with Okta as Identity Provider
###############################################

# BIG-IP Connection Details
bigip_mgmt: "{{ ansible_host }}"
bigip_username: "{{ bigip_user }}"
bigip_password: "{{ bigip_pass }}"
bigip_port: 443
bigip_validate_certs: no

# Solution name (used as prefix for all objects)
vs1_name: "solution3"

# DNS and domain configuration
dns1_name: "sp.acme.com"  # SAML Service Provider FQDN
path_name: "solution3"
partition_name: "solution3"

# Customization type (modern, standard)
custom_type: "modern"

# Feature flags
create_as3_application: true
create_gslb: false

# SAML Identity Provider Configuration (Okta)
saml_idp:
  name: "{{ vs1_name }}-sso"
  entity_id: "http://www.okta.com/exkafm6qvkEv6UK0d4x6"
  sso_uri: "https://dev-818899.okta.com/app/f5dev818899_spacmecom_1/exkafm6qvkEv6UK0d4x6/sso/saml"
  sso_binding: "http-post"
  slo_binding: "http-post"
  signature_type: "rsa-sha256"
  identity_location: "subject"
  artifact_resolution_service_addr: "any6"
  artifact_resolution_service_port: 0
  location_specific: "false"
  sign_artifact_resolution_rq: "false"
  want_authn_request_signed: "false"
  want_detached_signature: "false"

  # IDP certificate configuration
  certificate_name: "{{ vs1_name }}-idp"
  # Certificate content (PEM format) - This is the Okta dev-818899 test certificate from the Postman collection
  # Replace with your actual IDP certificate in production
  certificate_content: |
    -----BEGIN CERTIFICATE-----
    MIIDpDCCAoygAwIBAgIGAXGJ4bHiMA0GCSqGSIb3DQEBCwUAMIGSMQswCQYDVQQG
    EwJVUzETMBEGA1UECAwKQ2FsaWZvcm5pYTEWMBQGA1UEBwwNU2FuIEZyYW5jaXNj
    bzENMAsGA1UECgwET2t0YTEUMBIGA1UECwwLU1NPUHJvdmlkZXIxEzARBgNVBAMM
    CmRldi04MTg4OTkxHDAaBgkqhkiG9w0BCQEWDWluZm9Ab2t0YS5jb20wHhcNMjAw
    NDE3MjA0MjIxWhcNMzAwNDE3MjA0MzIxWjCBkjELMAkGA1UEBhMCVVMxEzARBgNV
    BAgMCkNhbGlmb3JuaWExFjAUBgNVBAcMDVNhbiBGcmFuY2lzY28xDTALBgNVBAoM
    BE9rdGExFDASBgNVBAsMC1NTT1Byb3ZpZGVyMRMwEQYDVQQDDApkZXYtODE4ODk5
    MRwwGgYJKoZIhvcNAQkBFg1pbmZvQG9rdGEuY29tMIIBIjANBgkqhkiG9w0BAQEF
    AAOCAQ8AMIIBCgKCAQEAsmCMufvHNoTyZz/KzzZsal/8jzHW6uhoaDNsOcFSmCHQ
    8lzLCEWH0zbQVFXbn6jnx5aJT8HJARqgqhUGVcD1LEeZzx23kqD1/zmpppJWhqiq
    bR8gInoA8yClzvMSSA23UPtbfuZiFMBFY0kawqhwAEKBuOqjko6QOxOh+ozZe9Bp
    /SUAUfqjEw38Ev5RndzogAN50xh7I+/3mnPq31IrCqzhJ/CYEHDXliaw3yb8PjMM
    RMJn5RrCOgQuWLEq73yX6NqamUGB6HM4cx0tNE/BIYYj25lh2ThVCtoP+tz3uJt+
    g/R49uhscqgEYHrfPYCYmI0yKLDU+327jxTi4xDEhQIDAQABMA0GCSqGSIb3DQEB
    CwUAA4IBAQCaxWWl4uZHI0F53SvLr3UTuKE7kmAIKkDi5t0kgROGVz/YxA3J6+c2
    5iP2qzwiSvFv1fhA4vs5aBifdkoa21C0qoeBmhQoTA9F76rv/QpL+kcgC/Hl4USy
    r7J9hoR91qWsxHNBSll/eY2FyxW4eSmrjwsaBZ6J8voY8iJwnMEgyoCpi4MJDlLI
    SOzpSSgcOet213xFhn5Yg0QCsgcv549kaD6c/rPtYbHvDxDyb6QhzSMjNbKiEL/2
    QI3BHAh5TMk/G8vELuXjTm3/3DcJFn19HH0n+vud68Z+wHKbA2BmtX1ANiLjPdLR
    w3t2s/OiCoHysKdTs6GXBlrk++DzP4ih
    -----END CERTIFICATE-----

# SAML Service Provider Configuration
saml_sp:
  name: "{{ dns1_name }}-sp"
  entity_id: "https://{{ dns1_name }}"
  sp_host: "{{ dns1_name }}"
  sp_scheme: "https"
  assertion_consumer_binding: "http-post"
  auth_context_comparison_method: "exact"
  force_authn: "false"
  is_authn_request_signed: "false"
  location_specific: "false"
  name_id_policy_allow_create: "true"
  want_assertion_encrypted: "false"
  want_assertion_signed: "true"

# APM Access Policy Settings
access_policy:
  name: "{{ vs1_name }}-psp"
  type: "access-policy"
  max_macro_loop_count: 1
  oneshot_macro: "false"

# APM Access Profile Settings
access_profile:
  name: "{{ vs1_name }}-psp"
  accept_languages: ["en"]
  default_language: "en"
  access_policy_timeout: 300
  inactivity_timeout: 900
  logout_uri_timeout: 5
  max_concurrent_sessions: 0
  max_concurrent_users: 0
  max_failure_delay: 5
  max_in_progress_sessions: 128
  max_session_timeout: 604800  # 7 days
  min_failure_delay: 2
  httponly_cookie: "false"
  persistent_cookie: "false"
  restrict_to_single_client_ip: "false"
  scope: "profile"
  secure_cookie: "true"
  type: "all"
  use_http_503_on_error: "false"
  user_identity_method: "http"
  log_settings: ["/Common/default-log-setting"]

# Customization Groups
customization_groups:
  - name: "{{ vs1_name }}-psp_logout"
    type: "logout"
    source: "/Common/{{ custom_type }}"

  - name: "{{ vs1_name }}-psp_eps"
    type: "eps"
    source: "/Common/{{ custom_type }}"

  - name: "{{ vs1_name }}-psp_errormap"
    type: "errormap"
    source: "/Common/{{ custom_type }}"

  - name: "{{ vs1_name }}-psp_framework_installation"
    type: "framework-installation"
    source: "/Common/{{ custom_type }}"

  - name: "{{ vs1_name }}-psp_general_ui"
    type: "general-ui"
    source: "/Common/{{ custom_type }}"

  - name: "{{ vs1_name }}-psp_end_deny_ag"
    type: "logout"
    source: "/Common/{{ custom_type }}"

# Policy Agents
policy_agents:
  deny_ending:
    name: "{{ vs1_name }}-psp_end_deny_ag"
    customization_group: "/Common/{{ vs1_name }}-psp_end_deny_ag"

  allow_ending:
    name: "{{ vs1_name }}-psp_end_allow_ag"

  saml_auth:
    name: "{{ vs1_name }}-psp_act_saml_auth_ag"
    force_authn: "use-aaa-server-setting"
    server: "/Common/{{ dns1_name }}-sp"

# Policy Items
policy_items:
  start:
    name: "{{ vs1_name }}-psp_ent"
    caption: "Start"
    color: 1
    item_type: "entry"
    loop: "false"
    next_item: "/Common/{{ vs1_name }}-psp_act_saml_auth"

  deny_ending:
    name: "{{ vs1_name }}-psp_end_deny"
    caption: "Deny"
    color: 2
    item_type: "ending"
    agent_type: "ending-deny"

  allow_ending:
    name: "{{ vs1_name }}-psp_end_allow"
    caption: "Allow"
    color: 1
    item_type: "ending"
    agent_type: "ending-allow"

  saml_auth:
    name: "{{ vs1_name }}-psp_act_saml_auth"
    caption: "SAML Auth"
    color: 1
    item_type: "action"
    loop: "false"
    agent_type: "aaa-saml"
    # Branching rules
    success_expression: 'expr {[mcget {session.saml.last.result}] == 1}'
    success_next_item: "/Common/{{ vs1_name }}-psp_end_allow"
    fallback_next_item: "/Common/{{ vs1_name }}-psp_end_deny"

# AS3 Virtual Server Configuration
as3_config:
  virtual_address: "10.1.10.130"
  virtual_port: 443
  pool_members:
    - "10.1.20.6:80"

  # SSL/TLS Configuration
  # Using default BIG-IP self-signed certificate
  # To use your own certificate, change these to match your FQDN certificate name on BIG-IP
  # Example: tls_cert_name: "acme.com-wildcard" (certificate must exist in /Common partition)
  tls_cert_name: "default.crt"
  tls_key_name: "default.key"

  # Pool configuration
  pool_name: "iis-pool"
  pool_monitor: "tcp"

  # SNAT configuration
  snat: "auto"

# GSLB Configuration (optional)
gslb_config:
  wideip_name: "{{ dns1_name }}"
  pool_name: "{{ vs1_name }}-pool"
  pool_members:
    - ip: "10.1.10.130"
      port: 443
