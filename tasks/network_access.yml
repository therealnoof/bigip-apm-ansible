---
###############################################
# Network Access Resource Configuration
###############################################

- name: Create VPN IP lease pool
  uri:
    url: "https://{{ bigip_mgmt }}:{{ bigip_port }}/mgmt/tm/apm/resource/leasepool/"
    method: POST
    user: "{{ bigip_username }}"
    password: "{{ bigip_password }}"
    validate_certs: "{{ bigip_validate_certs }}"
    body_format: json
    body:
      name: "{{ vs1_name }}-vpn_pool"
      partition: "Common"
      locationSpecific: "true"
      members:
        - "{{ vpn_lease_pool_start }}-{{ vpn_lease_pool_end }}"
    status_code: [200, 201, 409]
  delegate_to: localhost
  register: lease_pool_result
  when: create_network_access | bool

- name: Display lease pool creation result
  debug:
    msg: "VPN lease pool {{ vs1_name }}-vpn_pool - {{ 'created' if lease_pool_result.status == 200 or lease_pool_result.status == 201 else 'already exists' }}"
  when: create_network_access | bool

- name: Create network access customization group
  uri:
    url: "https://{{ bigip_mgmt }}:{{ bigip_port }}/mgmt/tm/apm/policy/customization-group/"
    method: POST
    user: "{{ bigip_username }}"
    password: "{{ bigip_password }}"
    validate_certs: "{{ bigip_validate_certs }}"
    body_format: json
    body:
      name: "{{ vs1_name }}-vpn_resource_network_access_customization"
      partition: "Common"
      type: "resource-network-access"
      source: "/Common/standard"
    status_code: [200, 201, 409]
  delegate_to: localhost
  register: na_custom_result
  when: create_network_access | bool

- name: Display network access customization result
  debug:
    msg: "Network access customization group - {{ 'created' if na_custom_result.status == 200 or na_custom_result.status == 201 else 'already exists' }}"
  when: create_network_access | bool

- name: Create network access resource
  uri:
    url: "https://{{ bigip_mgmt }}:{{ bigip_port }}/mgmt/tm/apm/resource/network-access/"
    method: POST
    user: "{{ bigip_username }}"
    password: "{{ bigip_password }}"
    validate_certs: "{{ bigip_validate_certs }}"
    body_format: json
    body:
      name: "{{ vs1_name }}-vpn"
      partition: "Common"
      addressSpaceDhcpRequestsExcluded: "true"
      addressSpaceLocDnsServersExcluded: "false"
      addressSpaceLocalSubnetsExcluded: "false"
      addressSpaceProtect: "false"
      customizationGroup: "/Common/{{ vs1_name }}-vpn_resource_network_access_customization"
      dtls: "false"
      dtlsPort: 4433
      leasepoolName: "/Common/{{ vs1_name }}-vpn_pool"
      locationSpecific: "true"
      snat: "automap"
      splitTunneling: "true"
      type: "network-access"
      addressSpaceIncludeSubnet:
        - subnet: "{{ vpn_split_tunnel_networks[0] }}"
        - subnet: "{{ vpn_split_tunnel_networks[1] }}"
    status_code: [200, 201, 409]
  delegate_to: localhost
  register: na_resource_result
  when: create_network_access | bool

- name: Display network access resource result
  debug:
    msg: "Network access resource {{ vs1_name }}-vpn - {{ 'created' if na_resource_result.status == 200 or na_resource_result.status == 201 else 'already exists' }} with split tunneling for {{ vpn_split_tunnel_networks | join(', ') }}"
  when: create_network_access | bool
