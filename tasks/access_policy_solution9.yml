---
# Solution 9: OAuth Resource Server Access Policy
# Creates the access policy for OAuth token validation
#
# Policy Flow:
# Start -> OAuth Scope -> Allow
#                     \-> Deny
#
# This is a simple policy that validates OAuth tokens from the Authorization Server

# =============================================================================
# START TRANSACTION
# =============================================================================

- name: Create transaction for access policy
  uri:
    url: "https://{{ bigip_mgmt }}:{{ bigip_port }}/mgmt/tm/transaction"
    method: POST
    user: "{{ bigip_username }}"
    password: "{{ bigip_password }}"
    validate_certs: "{{ validate_certs }}"
    body_format: json
    body: {}
    status_code: [200, 201]
  register: transaction

- name: Set transaction ID
  set_fact:
    trans_id: "{{ transaction.json.transId }}"

- name: Display transaction ID
  debug:
    msg: "Transaction ID: {{ trans_id }}"

# =============================================================================
# CREATE CUSTOMIZATION GROUPS
# =============================================================================

- name: Create customization groups
  uri:
    url: "https://{{ bigip_mgmt }}:{{ bigip_port }}/mgmt/tm/apm/policy/customization-group"
    method: POST
    user: "{{ bigip_username }}"
    password: "{{ bigip_password }}"
    validate_certs: "{{ validate_certs }}"
    headers:
      X-F5-REST-Coordination-Id: "{{ trans_id }}"
    body_format: json
    body:
      name: "{{ item.name }}"
      partition: "Common"
      source: "{{ item.source }}"
      type: "{{ item.type }}"
    status_code: [200, 201, 409]
  loop: "{{ customization_groups }}"
  loop_control:
    label: "{{ item.name }}"

# =============================================================================
# CREATE POLICY AGENTS
# =============================================================================

- name: Create deny ending agent
  uri:
    url: "https://{{ bigip_mgmt }}:{{ bigip_port }}/mgmt/tm/apm/policy/agent/ending-deny"
    method: POST
    user: "{{ bigip_username }}"
    password: "{{ bigip_password }}"
    validate_certs: "{{ validate_certs }}"
    headers:
      X-F5-REST-Coordination-Id: "{{ trans_id }}"
    body_format: json
    body:
      name: "{{ policy_agents.deny_ending.name }}"
      partition: "{{ policy_agents.deny_ending.partition }}"
      customizationGroup: "{{ policy_agents.deny_ending.customization_group }}"
    status_code: [200, 201, 409]

- name: Create allow ending agent
  uri:
    url: "https://{{ bigip_mgmt }}:{{ bigip_port }}/mgmt/tm/apm/policy/agent/ending-allow"
    method: POST
    user: "{{ bigip_username }}"
    password: "{{ bigip_password }}"
    validate_certs: "{{ validate_certs }}"
    headers:
      X-F5-REST-Coordination-Id: "{{ trans_id }}"
    body_format: json
    body:
      name: "{{ policy_agents.allow_ending.name }}"
      partition: "{{ policy_agents.allow_ending.partition }}"
    status_code: [200, 201, 409]

# OAuth Scope Agent - different body depending on token validation mode
# Internal mode (JWT): requires jwtProviderList
# External mode (introspection): requires oauthProvider, no jwtProviderList
- name: Create OAuth scope agent (external/introspection mode)
  uri:
    url: "https://{{ bigip_mgmt }}:{{ bigip_port }}/mgmt/tm/apm/policy/agent/aaa-oauth"
    method: POST
    user: "{{ bigip_username }}"
    password: "{{ bigip_password }}"
    validate_certs: "{{ validate_certs }}"
    headers:
      X-F5-REST-Coordination-Id: "{{ trans_id }}"
    body_format: json
    body:
      name: "{{ policy_agents.oauth_scope.name }}"
      partition: "{{ policy_agents.oauth_scope.partition }}"
      grantType: "{{ policy_agents.oauth_scope.grant_type }}"
      oauthProvider: "{{ policy_agents.oauth_scope.oauth_provider }}"
      openidConnect: "{{ policy_agents.oauth_scope.openid_connect }}"
      openidFlowType: "{{ policy_agents.oauth_scope.openid_flow_type }}"
      redirectionUri: "{{ policy_agents.oauth_scope.redirection_uri }}"
      tokenValidationMode: "{{ policy_agents.oauth_scope.token_validation_mode }}"
      type: "{{ policy_agents.oauth_scope.type }}"
    status_code: [200, 201, 409]
  when: token_validation_mode == "external"

- name: Create OAuth scope agent (internal/JWT mode)
  uri:
    url: "https://{{ bigip_mgmt }}:{{ bigip_port }}/mgmt/tm/apm/policy/agent/aaa-oauth"
    method: POST
    user: "{{ bigip_username }}"
    password: "{{ bigip_password }}"
    validate_certs: "{{ validate_certs }}"
    headers:
      X-F5-REST-Coordination-Id: "{{ trans_id }}"
    body_format: json
    body:
      name: "{{ policy_agents.oauth_scope.name }}"
      partition: "{{ policy_agents.oauth_scope.partition }}"
      grantType: "{{ policy_agents.oauth_scope.grant_type }}"
      jwtProviderList: "{{ policy_agents.oauth_scope.jwt_provider_list }}"
      openidConnect: "{{ policy_agents.oauth_scope.openid_connect }}"
      openidFlowType: "{{ policy_agents.oauth_scope.openid_flow_type }}"
      redirectionUri: "{{ policy_agents.oauth_scope.redirection_uri }}"
      tokenValidationMode: "{{ policy_agents.oauth_scope.token_validation_mode }}"
      type: "{{ policy_agents.oauth_scope.type }}"
    status_code: [200, 201, 409]
  when: token_validation_mode == "internal"

# =============================================================================
# CREATE POLICY ITEMS
# =============================================================================

- name: Create deny ending policy item
  uri:
    url: "https://{{ bigip_mgmt }}:{{ bigip_port }}/mgmt/tm/apm/policy/policy-item"
    method: POST
    user: "{{ bigip_username }}"
    password: "{{ bigip_password }}"
    validate_certs: "{{ validate_certs }}"
    headers:
      X-F5-REST-Coordination-Id: "{{ trans_id }}"
    body_format: json
    body:
      name: "{{ policy_items.deny_ending.name }}"
      partition: "{{ policy_items.deny_ending.partition }}"
      caption: "{{ policy_items.deny_ending.caption }}"
      color: "{{ policy_items.deny_ending.color }}"
      itemType: "{{ policy_items.deny_ending.item_type }}"
      agents:
        - name: "{{ policy_agents.deny_ending.name }}"
          partition: "{{ policy_agents.deny_ending.partition }}"
          type: "{{ policy_items.deny_ending.agent_type }}"
    status_code: [200, 201, 409]

- name: Create allow ending policy item
  uri:
    url: "https://{{ bigip_mgmt }}:{{ bigip_port }}/mgmt/tm/apm/policy/policy-item"
    method: POST
    user: "{{ bigip_username }}"
    password: "{{ bigip_password }}"
    validate_certs: "{{ validate_certs }}"
    headers:
      X-F5-REST-Coordination-Id: "{{ trans_id }}"
    body_format: json
    body:
      name: "{{ policy_items.allow_ending.name }}"
      partition: "{{ policy_items.allow_ending.partition }}"
      caption: "{{ policy_items.allow_ending.caption }}"
      color: "{{ policy_items.allow_ending.color }}"
      itemType: "{{ policy_items.allow_ending.item_type }}"
      agents:
        - name: "{{ policy_agents.allow_ending.name }}"
          partition: "{{ policy_agents.allow_ending.partition }}"
          type: "{{ policy_items.allow_ending.agent_type }}"
    status_code: [200, 201, 409]

- name: Create OAuth scope policy item
  uri:
    url: "https://{{ bigip_mgmt }}:{{ bigip_port }}/mgmt/tm/apm/policy/policy-item"
    method: POST
    user: "{{ bigip_username }}"
    password: "{{ bigip_password }}"
    validate_certs: "{{ validate_certs }}"
    headers:
      X-F5-REST-Coordination-Id: "{{ trans_id }}"
    body_format: json
    body:
      name: "{{ policy_items.oauth_scope.name }}"
      partition: "{{ policy_items.oauth_scope.partition }}"
      caption: "{{ policy_items.oauth_scope.caption }}"
      color: "{{ policy_items.oauth_scope.color }}"
      itemType: "{{ policy_items.oauth_scope.item_type }}"
      loop: "{{ policy_items.oauth_scope.loop }}"
      agents:
        - name: "{{ policy_agents.oauth_scope.name }}"
          partition: "{{ policy_agents.oauth_scope.partition }}"
          type: "{{ policy_items.oauth_scope.agent_type }}"
      rules:
        - caption: "{{ policy_items.oauth_scope.rules[0].caption }}"
          expression: "{{ policy_items.oauth_scope.rules[0].expression }}"
          nextItem: "{{ policy_items.oauth_scope.rules[0].nextItem }}"
        - caption: "{{ policy_items.oauth_scope.rules[1].caption }}"
          nextItem: "{{ policy_items.oauth_scope.rules[1].nextItem }}"
    status_code: [200, 201, 409]

- name: Create entry/start policy item
  uri:
    url: "https://{{ bigip_mgmt }}:{{ bigip_port }}/mgmt/tm/apm/policy/policy-item"
    method: POST
    user: "{{ bigip_username }}"
    password: "{{ bigip_password }}"
    validate_certs: "{{ validate_certs }}"
    headers:
      X-F5-REST-Coordination-Id: "{{ trans_id }}"
    body_format: json
    body:
      name: "{{ policy_items.entry.name }}"
      partition: "{{ policy_items.entry.partition }}"
      caption: "{{ policy_items.entry.caption }}"
      color: "{{ policy_items.entry.color }}"
      itemType: "{{ policy_items.entry.item_type }}"
      loop: "{{ policy_items.entry.loop }}"
      rules:
        - caption: "{{ policy_items.entry.rules[0].caption }}"
          nextItem: "{{ policy_items.entry.rules[0].nextItem }}"
    status_code: [200, 201, 409]

# =============================================================================
# CREATE ACCESS POLICY
# =============================================================================

- name: Create access policy
  uri:
    url: "https://{{ bigip_mgmt }}:{{ bigip_port }}/mgmt/tm/apm/policy/access-policy"
    method: POST
    user: "{{ bigip_username }}"
    password: "{{ bigip_password }}"
    validate_certs: "{{ validate_certs }}"
    headers:
      X-F5-REST-Coordination-Id: "{{ trans_id }}"
    body_format: json
    body:
      name: "{{ access_policy.name }}"
      partition: "{{ access_policy.partition }}"
      defaultEnding: "{{ access_policy.default_ending }}"
      maxMacroLoopCount: "{{ access_policy.max_macro_loop_count }}"
      oneshotMacro: "{{ access_policy.oneshot_macro }}"
      startItem: "{{ access_policy.start_item }}"
      type: "{{ access_policy.type }}"
      items: "{{ access_policy.policy_items_list }}"
    status_code: [200, 201, 409]

# =============================================================================
# CREATE ACCESS PROFILE
# =============================================================================

- name: Create access profile
  uri:
    url: "https://{{ bigip_mgmt }}:{{ bigip_port }}/mgmt/tm/apm/profile/access"
    method: POST
    user: "{{ bigip_username }}"
    password: "{{ bigip_password }}"
    validate_certs: "{{ validate_certs }}"
    headers:
      X-F5-REST-Coordination-Id: "{{ trans_id }}"
    body_format: json
    body:
      name: "{{ access_profile.name }}"
      partition: "{{ access_profile.partition }}"
      accessPolicy: "{{ access_profile.access_policy }}"
      acceptLanguages: "{{ access_profile.accept_languages }}"
      defaultLanguage: "{{ access_profile.default_language }}"
      customizationGroup: "{{ access_profile.customization_group }}"
      epsGroup: "{{ access_profile.eps_group }}"
      errormapGroup: "{{ access_profile.errormap_group }}"
      frameworkInstallationGroup: "{{ access_profile.framework_installation_group }}"
      generalUiGroup: "{{ access_profile.general_ui_group }}"
      accessPolicyTimeout: "{{ access_profile.access_policy_timeout }}"
      inactivityTimeout: "{{ access_profile.inactivity_timeout }}"
      maxSessionTimeout: "{{ access_profile.max_session_timeout }}"
      logoutUriTimeout: "{{ access_profile.logout_uri_timeout }}"
      maxConcurrentSessions: "{{ access_profile.max_concurrent_sessions }}"
      maxConcurrentUsers: "{{ access_profile.max_concurrent_users }}"
      maxFailureDelay: "{{ access_profile.max_failure_delay }}"
      minFailureDelay: "{{ access_profile.min_failure_delay }}"
      maxInProgressSessions: "{{ access_profile.max_in_progress_sessions }}"
      httponlyCookie: "{{ access_profile.httponly_cookie }}"
      persistentCookie: "{{ access_profile.persistent_cookie }}"
      secureCookie: "{{ access_profile.secure_cookie }}"
      restrictToSingleClientIp: "{{ access_profile.restrict_to_single_client_ip }}"
      scope: "{{ access_profile.scope }}"
      type: "{{ access_profile.type }}"
      useHttp503OnError: "{{ access_profile.use_http_503_on_error }}"
      userIdentityMethod: "{{ access_profile.user_identity_method }}"
      modifiedSinceLastPolicySync: "{{ access_profile.modified_since_last_policy_sync }}"
      logSettings: "{{ access_profile.log_settings }}"
    status_code: [200, 201, 409]

# =============================================================================
# COMMIT TRANSACTION
# =============================================================================

- name: Commit transaction
  uri:
    url: "https://{{ bigip_mgmt }}:{{ bigip_port }}/mgmt/tm/transaction/{{ trans_id }}"
    method: PUT
    user: "{{ bigip_username }}"
    password: "{{ bigip_password }}"
    validate_certs: "{{ validate_certs }}"
    body_format: json
    body:
      state: "VALIDATING"
    status_code: [200]
    timeout: 120
  register: commit_result

- name: Display commit result
  debug:
    msg: "Transaction {{ trans_id }} committed successfully"

# =============================================================================
# APPLY POLICY
# =============================================================================

- name: Apply access policy
  uri:
    url: "https://{{ bigip_mgmt }}:{{ bigip_port }}/mgmt/tm/apm/profile/access/~Common~{{ access_profile.name }}"
    method: PATCH
    user: "{{ bigip_username }}"
    password: "{{ bigip_password }}"
    validate_certs: "{{ validate_certs }}"
    body_format: json
    body:
      generationAction: "increment"
    status_code: [200]
